name: Feedlink-API Deploy

on:
  push:
    branches: ["master"]

jobs:
  deploy-laravel:
    runs-on: [self-hosted, feedlink-api]

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Setup PHP 8.2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_pgsql, redis

      # 3️⃣ Install composer dependencies
      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      # 4️⃣ Create .env from GitHub Secrets
      - name: Create .env from Secrets
        run: |
          echo "APP_NAME=Feedlink" > .env
          echo "APP_ENV=production" >> .env
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
          echo "APP_DEBUG=false" >> .env
          echo "APP_URL=${{ secrets.APP_URL }}" >> .env
          echo "DB_CONNECTION=pgsql" >> .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
          echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          # add other secrets if needed

      # 5️⃣ Deploy Laravel App
      - name: Deploy Laravel App
        run: |
          rsync -av --exclude='.env' ./ /var/www/feedlink-api/
          chown -R www-data:www-data /var/www/feedlink-api
          chmod -R 775 /var/www/feedlink-api/storage /var/www/feedlink-api/bootstrap/cache

      # 6️⃣ Restart PHP-FPM to apply changes
      - name: Restart PHP-FPM
        run: sudo systemctl restart php8.2-fpm
